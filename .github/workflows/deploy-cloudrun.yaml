name: Deploy to Cloud Run with GPU

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: image-search-inference
  REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev

jobs:
  check-base-image:
    name: Check if base image needs rebuild
    runs-on: ubuntu-latest
    outputs:
      base-changed: ${{ steps.check.outputs.base-changed }}
      base-hash: ${{ steps.hash.outputs.base-hash }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Calculate base image hash
      id: hash
      run: |
        BASE_HASH=$(sha256sum docker/base.dockerfile pyproject.toml | sha256sum | cut -d' ' -f1)
        echo "base-hash=$BASE_HASH" >> $GITHUB_OUTPUT
        echo "Base hash: $BASE_HASH"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Check if base image exists
      id: check
      run: |
        BASE_TAG="base-${{ steps.hash.outputs.base-hash }}"
        if gcloud artifacts docker images list ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service --include-tags --filter="tags:$BASE_TAG" --format="value(tags)" | grep -q "$BASE_TAG"; then
          echo "base-changed=false" >> $GITHUB_OUTPUT
          echo "Base image exists with hash $BASE_TAG"
        else
          echo "base-changed=true" >> $GITHUB_OUTPUT
          echo "Base image needs to be built with hash $BASE_TAG"
        fi

  build-base:
    name: Build base image
    runs-on: ubuntu-latest
    needs: check-base-image
    if: needs.check-base-image.outputs.base-changed == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        docker system prune -af
        df -h

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker to use Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build and Push Base Image
      run: |
        BASE_TAG="base-${{ needs.check-base-image.outputs.base-hash }}"
        docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/base:latest -f docker/base.dockerfile .
        docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/base:latest ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/base:$BASE_TAG
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/base:latest
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/base:$BASE_TAG

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [check-base-image, build-base]
    if: always() && !cancelled()

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker to use Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build and Push Inference Image
      run: |
        docker build \
          --build-arg PROJECT_ID=${{ env.PROJECT_ID }} \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:latest \
          -f docker/inference.dockerfile .
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:latest

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --region=${{ env.REGION }} \
          --platform=managed \
          --allow-unauthenticated \
          --port=8000 \
          --memory=16Gi \
          --cpu=4 \
          --gpu=1 \
          --gpu-type=nvidia-l4 \
          --max-instances=1 \
          --min-instances=0 \
          --timeout=3600 \
          --concurrency=50 \
          --set-env-vars="PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" \
          --set-env-vars="PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}" \
          --set-env-vars="REDIS_URL=${{ secrets.REDIS_URL }}" \
          --set-env-vars="GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}"

    - name: Get service URL
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)')
        echo "Service deployed at: $SERVICE_URL"
        echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

    - name: Test deployment
      run: |
        curl -f "${{ env.SERVICE_URL }}/docs" || echo "Service may still be warming up"
