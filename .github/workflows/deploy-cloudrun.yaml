name: Deploy to Cloud Run with GPU

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: image-search-inference
  REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker to use Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build and Push Base Image
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/base:latest -f docker/base.dockerfile .
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/base:latest

    - name: Build and Push Inference Image
      run: |
        docker build \
          --build-arg PROJECT_ID=${{ env.PROJECT_ID }} \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:latest \
          -f docker/inference.dockerfile .
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:latest

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/inference-service/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --region=${{ env.REGION }} \
          --platform=managed \
          --allow-unauthenticated \
          --port=8000 \
          --memory=8Gi \
          --cpu=4 \
          --gpu=1 \
          --gpu-type=nvidia-l4 \
          --max-instances=10 \
          --min-instances=0 \
          --timeout=3600 \
          --concurrency=1000 \
          --set-env-vars="PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" \
          --set-env-vars="PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}" \
          --set-env-vars="REDIS_URL=${{ secrets.REDIS_URL }}" \
          --set-env-vars="GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}"

    - name: Get service URL
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)')
        echo "Service deployed at: $SERVICE_URL"
        echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

    - name: Test deployment
      run: |
        curl -f "${{ env.SERVICE_URL }}/docs" || echo "Service may still be warming up"
